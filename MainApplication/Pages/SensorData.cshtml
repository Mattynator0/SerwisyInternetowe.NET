@page "{type?}"
@model MainApplication.Pages.SensorDataModel

<h2>Dane sensora: @Model.FilterType</h2>

<div style="margin-bottom: 1rem;">
    <label for="sensorTypeSelect">Wybierz typ sensora:</label>
    <select id="sensorTypeSelect">
        @foreach(var sensorType in Model.AvailableTypes)
        {
            <option value="@sensorType" @(sensorType == Model.FilterType ? "selected" : "")>@sensorType</option>
        }
    </select>
</div>

@if (string.IsNullOrEmpty(Model.FilterType))
{
    <p>Wybierz typ sensora</p>
}
else if (Model.SensorDataList.Count == 0)
{
    <p>Brak danych dla tego typu sensora.</p>
}
else
{
    <div style="float: right;">
        <button id="btnExportJson" class="btn btn-primary mb-2">Eksportuj JSON</button>
        <button id="btnExportCsv" class="btn btn-secondary mb-2">Eksportuj CSV</button>
    </div>

    <div>
        <label>Timestamp od:</label>
        <input type="datetime-local" id="timestampAfter"/>
        <label>Timestamp do:</label>
        <input type="datetime-local" id="timestampBefore"/>
    </div>

    <table id="myTable" class="display">
        <thead>
        <tr>
            <th><input type="text" placeholder="Szukaj SensorId"/></th>
            <th></th>
            <th></th>
            <th></th>
        </tr>
        <tr>
            <th>SensorId</th>
            <th>Type</th>
            <th>Value</th>
            <th>Timestamp</th>
        </tr>
        </thead>
        <tbody>
        @foreach (var item in Model.SensorDataList)
        {
            <tr>
                <td>@item.SensorId</td>
                <td>@item.Type</td>
                <td>@item.Value</td>
                <td data-timestamp="@item.Timestamp">@DateTimeOffset.FromUnixTimeMilliseconds(item.Timestamp).ToLocalTime().ToString("yyyy-MM-dd HH:mm:ss.fff")</td>
            </tr>
        }
        </tbody>
    </table>

    @section Scripts {
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
        <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css"/>

        <script>
            document.getElementById('sensorTypeSelect').addEventListener('change', function() {
                var selectedType = this.value;
                var url = '@Url.Page(null, null, new { type = "__type__" })'.replace('__type__', encodeURIComponent(selectedType));
                window.location.href = url;
            });
            
            $(document).ready(function () {
                var table = $('#myTable').DataTable({
                    dom: 'lrtip',
                    order: [[3, 'desc']],
                    columnDefs: [{targets: [1], orderable: false}]
                });

                $('#myTable thead tr:eq(0) th input').on('keyup change', function (e) {
                    var i = $(this).parent().index();
                    if (table.column(i).search() !== this.value) {
                        table.column(i).search(this.value).draw();
                    }
                });

                $.fn.dataTable.ext.search.push(
                    function (settings, data, dataIndex) {
                        var min = $('#timestampAfter').val() ? new Date($('#timestampAfter').val()).getTime() : null;
                        var max = $('#timestampBefore').val() ? new Date($('#timestampBefore').val()).getTime() : null;

                        var timestamp = parseInt($('td', table.row(dataIndex).node()).eq(3).attr('data-timestamp'), 10);

                        if (
                            (min === null && max === null) ||
                            (min === null && timestamp <= max) ||
                            (min <= timestamp && max === null) ||
                            (min <= timestamp && timestamp <= max)
                        ) {
                            return true;
                        }
                        return false;
                    }
                );

                $('#timestampAfter, #timestampBefore').on('change', function () {
                    table.draw();
                });

                $('#timestampAfter, #timestampBefore').on('keydown', function (e) {
                    if (e.key === "Backspace" || e.key === "Delete") {
                        e.preventDefault();
                        $(this).val('');
                        $('#myTable').DataTable().draw();
                    }
                });

                $('#btnExportJson').click(function () {
                    var table = $('#myTable').DataTable();
                    var data = table.rows({search: 'applied'}).data().toArray();
                    var json = JSON.stringify(data);
                    var blob = new Blob([json], {type: "application/json"});
                    var url = URL.createObjectURL(blob);

                    var a = document.createElement('a');
                    a.href = url;
                    a.download = 'data.json';
                    a.click();
                    URL.revokeObjectURL(url);
                });

                $('#btnExportCsv').click(function () {
                    var table = $('#myTable').DataTable();
                    var data = table.rows({search: 'applied'}).data().toArray();

                    var csv = 'SensorId,Type,Value,Timestamp\n';

                    data.forEach(function (row) {
                        csv += `"${row[0]}","${row[1]}","${row[2]}","${row[3]}"\n`;
                    });

                    var blob = new Blob([csv], {type: "text/csv"});
                    var url = URL.createObjectURL(blob);

                    var a = document.createElement('a');
                    a.href = url;
                    a.download = 'data.csv';
                    a.click();
                    URL.revokeObjectURL(url);
                });

            });
        </script>
    }
}